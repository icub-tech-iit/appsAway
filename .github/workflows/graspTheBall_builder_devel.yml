# this workflow will generate the containers on push. These containers are for test only, so ideally they should be uploaded to a private repo, not available to the public. tag=graspTheBall_devel (?)
# for the stable versions, use graspTheBall_builder_stable.yml, triggered on release

name: GTB_builder_devel

on: 
    repository_dispatch:
        types: [GTB_build_devel]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  repository: icub-tech-iit/code
                  token: ${{ secrets.CODE_REPO_ACCSS_TOKEN }}

            - name: check if clone succeeded
              run: |
                ls
                cd code
                ls
                cd .. 
            

            - name: Login to DockerHub Registry
              run: echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

##### Command to set the tag for the full superbuild Docker image (without version) #####
            - name: set builder tag for Superbuild unstable full
              run: echo "icubteamcode/superbuild:master-unstable_sources" > SB_DOCKER_TAG_FULL
#########################################################################################

##### Command to set the tag for the thin superbuild Docker image (without version) #####
            - name: set builder tag for Superbuild unstable thin
              run: echo "icubteamcode/superbuild:master-unstable_binaries" > SB_DOCKER_TAG_PROD
#########################################################################################

##### Command to set the tag for the full superbuild Docker image (without version) #####
            - name: set builder tag for Superbuild stable full
              run: echo "icubteamcode/superbuild:master-stable_sources" > SB_DOCKER_TAG_FULL_STAB
#########################################################################################

##### Command to set the tag for the thin superbuild Docker image (without version) #####
            - name: set builder tag for Superbuild stable thin
              run: echo "icubteamcode/superbuild:master-stable_binaries" > SB_DOCKER_TAG_PROD_STAB
#########################################################################################

######## Command to set the tag for the starting image argument for full Image ##########
            - name: set starting image argument for Docker build
              run: |
                echo "SUPERBUILD_FULL_NAME=$(cat SB_DOCKER_TAG_FULL)" > SUPERBUILD_IMAGE_FULL
                echo $(cat SUPERBUILD_IMAGE_FULL)
#########################################################################################
                
######## Command to set the tag for the starting image argument for thin Image ##########
            - name: set starting image argument for Docker build
              run: |
                echo "SUPERBUILD_THIN_NAME=$(cat SB_DOCKER_TAG_PROD)" > SUPERBUILD_IMAGE_THIN
                echo $(cat SUPERBUILD_IMAGE_THIN)
#########################################################################################

######## Command to set the tag for the starting image argument for full Image ##########
            - name: set starting image argument for Docker build
              run: |
                echo "SUPERBUILD_FULL_NAME=$(cat SB_DOCKER_TAG_FULL_STAB)" > SUPERBUILD_IMAGE_FULL_STAB
                echo $(cat SUPERBUILD_IMAGE_FULL_STAB)
#########################################################################################
                
######## Command to set the tag for the starting image argument for thin Image ##########
            - name: set starting image argument for Docker build
              run: |
                echo "SUPERBUILD_THIN_NAME=$(cat SB_DOCKER_TAG_PROD_STAB)" > SUPERBUILD_IMAGE_THIN_STAB
                echo $(cat SUPERBUILD_IMAGE_THIN_STAB)
#########################################################################################

############## build the unstable version of graspTheBall ##############
            - name: Build graspTheBall Docker full image
              run: docker build --build-arg $(cat SUPERBUILD_IMAGE_FULL) --build-arg $(cat SUPERBUILD_IMAGE_THIN) ./code/dockerfile_images/demos/graspTheBall --file ./code/dockerfile_images/demos/graspTheBall/Dockerfile --tag icubteamcode/grasptheball:master-unstable_sources
            - name: Push graspTheBall Docker full image
              run: docker push icubteamcode/grasptheball:master-unstable_sources

############## build the stable version of graspTheBall ##############
            - name: Build graspTheBall Docker full image
              run: docker build --build-arg $(cat SUPERBUILD_IMAGE_FULL_STAB) --build-arg $(cat SUPERBUILD_IMAGE_THIN_STAB) ./code/dockerfile_images/demos/graspTheBall --file ./code/dockerfile_images/demos/graspTheBall/Dockerfile --tag icubteamcode/grasptheball:master-stable_sources
            - name: Push graspTheBall Docker full image
              run: docker push icubteamcode/grasptheball:master-stable_sources
 
#########################################################################################

##### Command to set the tag for the full superbuild Docker image (without version) #####
            - name: set builder tag for Superbuild unstable full
              run: echo "icubteamcode/grasptheball:master-unstable_sources" > GTB_DOCKER_TAG_FULL
#########################################################################################

##### Command to set the tag for the full superbuild Docker image (without version) #####
            - name: set builder tag for Superbuild stable full
              run: echo "icubteamcode/grasptheball:master-stable_sources" > GTB_DOCKER_TAG_FULL_STAB
#########################################################################################

######## Command to set the tag for the starting image argument for full Image ##########
            - name: set starting image argument for Docker build
              run: |
                echo "START_IMAGE_FULL=$(cat GTB_DOCKER_TAG_FULL)" > START_IMAGE_UNST
                echo $(cat START_IMAGE_UNST)
#########################################################################################

######## Command to set the tag for the starting image argument for full Image ##########
            - name: set starting image argument for Docker build
              run: |
                echo "START_IMAGE_FULL=$(cat GTB_DOCKER_TAG_FULL_STAB)" > START_IMAGE_STAB
                echo $(cat START_IMAGE_STAB)
#########################################################################################

############## build the unstable version of graspTheBall ##############
            - name: Build graspTheBall Docker thin image
              run: docker build --build-arg $(cat START_IMAGE_UNST) --build-arg $(cat SUPERBUILD_IMAGE_THIN) ./code/dockerfile_images/demos/graspTheBall --file ./code/dockerfile_images/demos/graspTheBall/Dockerfile4Production --tag icubteamcode/grasptheball:master-unstable_binaries
            - name: Push graspTheBall Docker thin image
              run: docker push icubteamcode/grasptheball:master-unstable_binaries

############## build the stable version of graspTheBall ##############
            - name: Build graspTheBall Docker thin image
              run: docker build --build-arg $(cat START_IMAGE_STAB) --build-arg $(cat SUPERBUILD_IMAGE_THIN_STAB) ./code/dockerfile_images/demos/graspTheBall --file ./code/dockerfile_images/demos/graspTheBall/Dockerfile4Production --tag icubteamcode/grasptheball:master-stable_binaries
            - name: Push graspTheBall Docker thin image
              run: docker push icubteamcode/grasptheball:master-stable_binaries
#########################################################################################


