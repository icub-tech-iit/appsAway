# this workflow will generate the containers of superbuild-gazebo on push. These containers are for test only, so ideally they should be uploaded to a private repo, not available to the public. tag=superbuild_devel (?)
# for the stable versions, use superbuild_builder_stable.yml, triggered on release

name: SB_GZ_onCodeChanges

on: 
    repository_dispatch:
        types: [SB_GZ_onCodeChanges, SB_GZ_onSBRelease]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  repository: icub-tech-iit/code
                  token: ${{ secrets.CODE_REPO_ACCSS_TOKEN }}
            - name: Login to DockerHub Registry
              run: echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

########### This command sets the master/release variable ##############################
            - name: set release/master argument for Docker build
              run: |
                echo ${{ github.event.client_payload.version }} > RELEASE_TAG
                echo "release=$(cat RELEASE_TAG)" > RELEASE_ARG
                echo $(cat RELEASE_ARG)
#########################################################################################

######## Command to build the full Docker image, using only unstable tag #########
            - name: Build superbuild Docker full image
              run: docker build ${{ github.event.client_payload.docker_path }} --build-arg $(cat RELEASE_ARG) --file ${{ github.event.client_payload.docker_path }}/Dockerfile --tag ${{ github.event.client_payload.superbuild_gazebo_unst_src}}
#########################################################################################

######### Command to push the full Docker Image online ##################################
            - name: Push superbuild Docker full image
              run: docker push ${{ github.event.client_payload.superbuild_gazebo_unst_src }}
#########################################################################################

######## Command to build the thin Docker image, using only unstable tag #########
            - name: Build superbuild Docker thin image
              run: docker build ${{ github.event.client_payload.docker_path }} --file ${{ github.event.client_payload.docker_path }}/Dockerfile4Production --tag ${{ github.event.client_payload.superbuild_gazebo_unst_bin}}
#########################################################################################

######### Command to push the full Docker Image online ##################################
            - name: Push superbuild Docker thin image
              run: docker push ${{ github.event.client_payload.superbuild_gazebo_unst_bin}}
#########################################################################################
